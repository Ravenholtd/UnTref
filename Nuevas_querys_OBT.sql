create or replace view DB_BL_SCM.CL_SCM.DVW_FT_DAILY_ACTUAL_VOLUMES_AGGREGATED_BY_MONTH(
	DT_INGESTION_TIMESTAMP,
	GN_NETWORK_SUBJECT_GUID,
	GN_MARKET_GUID,
	GN_VEHICLE_VERSION_GUID,
	GN_OPERATIONAL_PLANNING_SALES_CHANNEL_GUID,
	GN_OPERATIONAL_PLANNING_SALES_SUBCHANNEL_GUID,
	DT_DAY_DATE,
	CD_DATA_OWNER_LOGICAL_REGION_CODE,
	NM_PRODUCTIONS_DAILY_NUMBER,
	NM_PRODUCTIONS_MONTH_TO_DATE_NUMBER,
	NM_WHOLESALES_DAILY_NUMBER,
	NM_WHOLESALES_MONTH_TO_DATE_NUMBER,
	NM_SALES_DAILY_NUMBER,
	NM_SALES_MONTH_TO_DATE_NUMBER,
	NM_REGISTRATION_DAILY_NUMBER,
	NM_REGISTRATION_MONTH_TO_DATE_NUMBER,
	NM_SALES_TO_CUSTOMER_DAILY_NUMBER,
	NM_SALES_TO_CUSTOMER_MONTH_TO_DATE_NUMBER,
	NM_PROPERTY_STOCK_NUMBER,
	NM_PROPERTY_STOCK_AGED_OVER_6_MONTHS_NUMBER,
	NM_PROPERTY_STOCK_TO_BE_SHIPPED_NUMBER,
	NM_PROPERTY_STOCK_TRAVELLING_NUMBER,
	NM_PROPERTY_STOCK_IN_TRANSIT_NUMBER,
	NM_PROPERTY_STOCK_ARRIVED_TO_MARKET_COMPOUND_NUMBER,
	NM_PROPERTY_STOCK_DIRECT_SALES_CHANNEL_NUMBER,
	NM_NETWORK_STOCK_NUMBER,
	NM_NETWORK_STOCK_AGED_OVER_6_MONTHS_NUMBER,
	NM_NETWORK_STOCK_AGED_OVER_6_MONTHS_PRODUCTION_NUMBER,
	NM_FINAL_CUSTOMER_ORDERS_DAILY_NUMBER,
	NM_FINAL_CUSTOMER_ORDERS_MONTH_TO_DATE_NUMBER,
	NM_FINAL_CUSTOMER_ORDERS_GROSS_DAILY_NUMBER,
	NM_FINAL_CUSTOMER_ORDERS_GROSS_MONTH_TO_DATE_NUMBER,
	NM_FINAL_CUSTOMER_ORDERS_PORTFOLIO_NUMBER,
	NM_PROPERTY_STOCK_FINAL_CUSTOMER_ORDERS_NUMBER,
	NM_PROPERTY_STOCK_FINAL_CUSTOMER_ORDERS_IN_TRANSIT_NUMBER,
	NM_PROPERTY_STOCK_FINAL_CUSTOMER_ORDERS_ARRIVED_TO_COMPOUND_NUMBER,
	NM_NETWORK_STOCK_FINAL_CUSTOMER_ORDERS_NUMBER,
	NM_PROPERTY_STOCK_AGED_UNDER_2_MONTHS_NUMBER,
	NM_PROPERTY_STOCK_AGED_BETWEEN_2_AND_3_MONTHS_NUMBER,
	NM_PROPERTY_STOCK_AGED_BETWEEN_3_AND_4_MONTHS_NUMBER,
	NM_PROPERTY_STOCK_AGED_BETWEEN_4_AND_5_MONTHS_NUMBER,
	NM_PROPERTY_STOCK_AGED_BETWEEN_5_AND_6_MONTHS_NUMBER,
	NM_PROPERTY_STOCK_AGED_BETWEEN_6_AND_9_MONTHS_NUMBER,
	NM_PROPERTY_STOCK_AGED_OVER_9_MONTHS_NUMBER,
	NM_NETWORK_STOCK_AGED_UNDER_2_MONTHS_NUMBER,
	NM_NETWORK_STOCK_AGED_BETWEEN_2_AND_4_MONTHS_NUMBER,
	NM_NETWORK_STOCK_AGED_BETWEEN_4_AND_5_MONTHS_NUMBER,
	NM_NETWORK_STOCK_AGED_BETWEEN_5_AND_6_MONTHS_NUMBER,
	NM_NETWORK_STOCK_AGED_BETWEEN_6_AND_9_MONTHS_NUMBER,
	NM_NETWORK_STOCK_AGED_BETWEEN_9_AND_12_MONTHS_NUMBER,
	NM_NETWORK_STOCK_AGED_OVER_12_MONTHS_NUMBER,
	NM_NETWORK_STOCK_AGED_UNDER_2_MONTHS_PRODUCTION_NUMBER,
	NM_NETWORK_STOCK_AGED_BETWEEN_2_AND_3_MONTHS_PRODUCTION_NUMBER,
	NM_NETWORK_STOCK_AGED_BETWEEN_3_AND_4_MONTHS_PRODUCTION_NUMBER,
	NM_NETWORK_STOCK_AGED_BETWEEN_4_AND_5_MONTHS_PRODUCTION_NUMBER,
	NM_NETWORK_STOCK_AGED_BETWEEN_5_AND_6_MONTHS_PRODUCTION_NUMBER,
	NM_NETWORK_STOCK_AGED_BETWEEN_6_AND_12_MONTHS_PRODUCTION_NUMBER,
	NM_NETWORK_STOCK_AGED_OVER_12_MONTHS_PRODUCTION_NUMBER
) COMMENT='Volumes realized for production, wholesale, distribution, sales and stock'
 as (
SELECT
	ft.DT_INGESTION_TIMESTAMP,
	ft.GN_NETWORK_SUBJECT_GUID,
	ft.GN_MARKET_GUID,
	ft.GN_VEHICLE_VERSION_GUID,
	ft.GN_OPERATIONAL_PLANNING_SALES_CHANNEL_GUID,
	ft.GN_OPERATIONAL_PLANNING_SALES_SUBCHANNEL_GUID,
	DB_TECH_FRAMEWORK.DG_UTILITIES.FN_JULIAN_TO_DATE(ft.GN_DAY_JULIAN_DATE) as DT_DAY_DATE,
	ft.CD_DATA_OWNER_LOGICAL_REGION_CODE,
	ft.NM_PRODUCTIONS_DAILY_NUMBER,
	ft.NM_PRODUCTIONS_MONTH_TO_DATE_NUMBER,
	ft.NM_WHOLESALES_DAILY_NUMBER,
	ft.NM_WHOLESALES_MONTH_TO_DATE_NUMBER,
	ft.NM_SALES_DAILY_NUMBER,
	ft.NM_SALES_MONTH_TO_DATE_NUMBER,
	ft.NM_REGISTRATION_DAILY_NUMBER,
	ft.NM_REGISTRATION_MONTH_TO_DATE_NUMBER,
	ft.NM_SALES_TO_CUSTOMER_DAILY_NUMBER,
	ft.NM_SALES_TO_CUSTOMER_MONTH_TO_DATE_NUMBER,
	ft.NM_PROPERTY_STOCK_NUMBER,
	ft.NM_PROPERTY_STOCK_AGED_OVER_6_MONTHS_NUMBER,
	ft.NM_PROPERTY_STOCK_TO_BE_SHIPPED_NUMBER,
	ft.NM_PROPERTY_STOCK_TRAVELLING_NUMBER,
	ft.NM_PROPERTY_STOCK_IN_TRANSIT_NUMBER,
	ft.NM_PROPERTY_STOCK_ARRIVED_TO_MARKET_COMPOUND_NUMBER,
	ft.NM_PROPERTY_STOCK_DIRECT_SALES_CHANNEL_NUMBER,
	ft.NM_NETWORK_STOCK_NUMBER,
	ft.NM_NETWORK_STOCK_AGED_OVER_6_MONTHS_NUMBER,
	ft.NM_NETWORK_STOCK_AGED_OVER_6_MONTHS_PRODUCTION_NUMBER,
	ft.NM_FINAL_CUSTOMER_ORDERS_DAILY_NUMBER,
	ft.NM_FINAL_CUSTOMER_ORDERS_MONTH_TO_DATE_NUMBER,
	ft.NM_FINAL_CUSTOMER_ORDERS_GROSS_DAILY_NUMBER,
	ft.NM_FINAL_CUSTOMER_ORDERS_GROSS_MONTH_TO_DATE_NUMBER,
	ft.NM_FINAL_CUSTOMER_ORDERS_PORTFOLIO_NUMBER,
	ft.NM_PROPERTY_STOCK_FINAL_CUSTOMER_ORDERS_NUMBER,
	ft.NM_PROPERTY_STOCK_FINAL_CUSTOMER_ORDERS_IN_TRANSIT_NUMBER,
	ft.NM_PROPERTY_STOCK_FINAL_CUSTOMER_ORDERS_ARRIVED_TO_COMPOUND_NUMBER,
	ft.NM_NETWORK_STOCK_FINAL_CUSTOMER_ORDERS_NUMBER,
	ft.NM_PROPERTY_STOCK_AGED_UNDER_2_MONTHS_NUMBER,
	ft.NM_PROPERTY_STOCK_AGED_BETWEEN_2_AND_3_MONTHS_NUMBER,
	ft.NM_PROPERTY_STOCK_AGED_BETWEEN_3_AND_4_MONTHS_NUMBER,
	ft.NM_PROPERTY_STOCK_AGED_BETWEEN_4_AND_5_MONTHS_NUMBER,
	ft.NM_PROPERTY_STOCK_AGED_BETWEEN_5_AND_6_MONTHS_NUMBER,
	ft.NM_PROPERTY_STOCK_AGED_BETWEEN_6_AND_9_MONTHS_NUMBER,
	ft.NM_PROPERTY_STOCK_AGED_OVER_9_MONTHS_NUMBER,
	ft.NM_NETWORK_STOCK_AGED_UNDER_2_MONTHS_NUMBER,
	ft.NM_NETWORK_STOCK_AGED_BETWEEN_2_AND_4_MONTHS_NUMBER,
	ft.NM_NETWORK_STOCK_AGED_BETWEEN_4_AND_5_MONTHS_NUMBER,
	ft.NM_NETWORK_STOCK_AGED_BETWEEN_5_AND_6_MONTHS_NUMBER,
	ft.NM_NETWORK_STOCK_AGED_BETWEEN_6_AND_9_MONTHS_NUMBER,
	ft.NM_NETWORK_STOCK_AGED_BETWEEN_9_AND_12_MONTHS_NUMBER,
	ft.NM_NETWORK_STOCK_AGED_OVER_12_MONTHS_NUMBER,
	ft.NM_NETWORK_STOCK_AGED_UNDER_2_MONTHS_PRODUCTION_NUMBER,
	ft.NM_NETWORK_STOCK_AGED_BETWEEN_2_AND_3_MONTHS_PRODUCTION_NUMBER,
	ft.NM_NETWORK_STOCK_AGED_BETWEEN_3_AND_4_MONTHS_PRODUCTION_NUMBER,
	ft.NM_NETWORK_STOCK_AGED_BETWEEN_4_AND_5_MONTHS_PRODUCTION_NUMBER,
	ft.NM_NETWORK_STOCK_AGED_BETWEEN_5_AND_6_MONTHS_PRODUCTION_NUMBER,
	ft.NM_NETWORK_STOCK_AGED_BETWEEN_6_AND_12_MONTHS_PRODUCTION_NUMBER,
	ft.NM_NETWORK_STOCK_AGED_OVER_12_MONTHS_PRODUCTION_NUMBER
FROM
	DB_BL_SCM.BL_SCM.FT_DAILY_ACTUAL_VOLUMES ft
INNER JOIN (SELECT MAX(FT.GN_DAY_JULIAN_DATE) AS GN_DAY_JULIAN_DATE, 
                    GN_NETWORK_SUBJECT_GUID,
                    gn_market_guid, 
                    gn_vehicle_version_guid, 
                    GN_OPERATIONAL_PLANNING_SALES_CHANNEL_GUID,
                    GN_OPERATIONAL_PLANNING_SALES_SUBCHANNEL_GUID
            FROM DB_BL_SCM.BL_SCM.FT_DAILY_ACTUAL_VOLUMES FT
			LEFT JOIN DB_BL_CMN.BL_CMN.DM_DAY DD ON DD.GN_DAY_JULIAN_DATE = FT.GN_DAY_JULIAN_DATE
			GROUP BY DD.CD_MONTH_CODE,
                       GN_NETWORK_SUBJECT_GUID,
                       gn_market_guid,
                       gn_vehicle_version_guid,
                       GN_OPERATIONAL_PLANNING_SALES_CHANNEL_GUID,
                       GN_OPERATIONAL_PLANNING_SALES_SUBCHANNEL_GUID) max_day
ON FT.GN_DAY_JULIAN_DATE = max_day.GN_DAY_JULIAN_DATE 
AND ft.GN_MARKET_GUID = max_day.GN_MARKET_GUID 
AND ft.GN_VEHICLE_VERSION_GUID = max_day.GN_VEHICLE_VERSION_GUID 
AND ft.GN_NETWORK_SUBJECT_GUID = max_day.GN_NETWORK_SUBJECT_GUID 
AND ft.GN_OPERATIONAL_PLANNING_SALES_CHANNEL_GUID = max_day.GN_OPERATIONAL_PLANNING_SALES_CHANNEL_GUID 
AND ft.GN_OPERATIONAL_PLANNING_SALES_SUBCHANNEL_GUID = max_day.GN_OPERATIONAL_PLANNING_SALES_SUBCHANNEL_GUID
where YEAR(DT_DAY_DATE)>= YEAR(CURRENT_DATE())-2)
;